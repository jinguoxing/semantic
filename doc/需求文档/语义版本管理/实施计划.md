# 语义版本管理 (Semantic Versioning) 实施计划

## 目标

构建**以语义版本为核心的知识驱动型数据平台**，实现：
- 语义版本作为"事实源（Source of Truth）"
- 每个版本 = 不可变快照
- 支持对比、回滚、Active 版本切换
- 问数/AI 只消费已发布的语义版本

---

## 架构定位

```
┌─────────────────────────┐
│   问数 / AI 能力层       │ ← 只消费 Active 语义版本
└───────────▲─────────────┘
            │
┌───────────┴─────────────┐
│   资源知识网络（Graph）   │ ← 基于语义版本构建
└───────────▲─────────────┘
            │
┌───────────┴─────────────┐
│  【语义版本】事实源        │ ← 本次实现重点
│  BO + 字段语义 + 关系     │
└───────────▲─────────────┘
            │ 发布
┌───────────┴─────────────┐
│  【业务对象建模】统一管理   │ ← 发布入口
└───────────▲─────────────┘
            │
    ┌───────┴───────┐
    ↑               ↑
┌───┴───┐       ┌───┴───┐
│自上而下│       │自下而上│
│场景建模│       │表识别  │
└───────┘       └───────┘
```

---

## 业务流转路径

### 自上而下（场景驱动）
```
业务场景描述 → AI 识别 → 候选 BO → 候选确认 → 业务对象建模 → 发布语义版本
```

### 自下而上（物理表驱动）
```
物理表 → 语义识别 → 候选 BO → 候选确认 → 业务对象建模 → 发布语义版本
```

> [!IMPORTANT]
> 两条路径在**候选确认**后统一汇聚到**业务对象建模**模块进行管理和发布

---

## Phase 1: 数据模型与存储服务

### 1.1 语义版本数据模型

#### [NEW] [semanticVersion.ts](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/types/semanticVersion.ts)

```typescript
interface SemanticVersion {
  version_id: string;           // "sv_1.0.0"
  version: string;              // "1.0.0"
  status: 'draft' | 'published' | 'deprecated';
  is_active: boolean;           // 当前活跃版本
  
  snapshot: {
    business_objects: BusinessObjectSnapshot[];
    field_semantics: FieldSemanticSnapshot[];
    object_relations: RelationSnapshot[];
    terms: TermSnapshot[];
    metrics: MetricSnapshot[];
  };
  
  created_at: string;
  published_at?: string;
  created_by?: string;
  change_summary?: string;
}
```

### 1.2 版本存储服务

#### [NEW] [semanticVersionService.ts](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/services/semantic/semanticVersionService.ts)

```typescript
class SemanticVersionService {
  async createDraft(): Promise<SemanticVersion>
  async publishVersion(draftId: string, changeSummary: string): Promise<void>
  async deprecateVersion(versionId: string): Promise<void>
  async getActiveVersion(): Promise<SemanticVersion | null>
  async getVersionHistory(): Promise<SemanticVersion[]>
  async setActiveVersion(versionId: string): Promise<void>
  async compareVersions(v1: string, v2: string): Promise<VersionDiff>
  async rollbackToVersion(versionId: string): Promise<void>
}
```

---

## Phase 2: 版本管理 UI

### 2.1 版本管理面板

#### [NEW] [SemanticVersionPanel.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/components/semantic-version/SemanticVersionPanel.tsx)

功能：
- 版本列表（时间线展示）
- Active 版本高亮
- 操作：查看详情、设为Active、回滚、废弃

### 2.2 版本对比视图

#### [NEW] [VersionDiffView.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/components/semantic-version/VersionDiffView.tsx)

功能：
- 两个版本并排对比
- 高亮：新增(绿)、删除(红)、修改(黄)

### 2.3 发布确认对话框

#### [NEW] [PublishVersionDialog.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/components/semantic-version/PublishVersionDialog.tsx)

功能：
- 输入变更摘要
- 预览发布内容
- 影响分析

---

## Phase 3: 业务对象建模集成

### 3.1 发布入口改造

#### [MODIFY] [BusinessModelingView.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/BusinessModelingView.tsx)

改造点：
- 批量发布 → 创建/更新语义版本草稿
- 新增"发布语义版本"按钮
- 显示当前关联的语义版本状态

### 3.2 候选确认流程统一

#### [MODIFY] [CandidateConfirmationView.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/CandidateConfirmationView.tsx)

改造点：
- 确认后的候选 BO 统一进入业务对象建模
- 保持自上而下/自下而上生成逻辑一致

### 3.3 业务场景建模调整

#### [MODIFY] [BusinessModelPanel.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/components/business-scenario/BusinessModelPanel.tsx)

改造点：
- "发布模型" → "加入候选" / "生成业务对象"
- 生成的 BO 进入业务对象建模模块统一管理
- 移除直接发布语义版本的功能

---

## Phase 4: 消费层绑定

### 4.1 问数绑定 Active 版本

#### [MODIFY] [AskDataView.tsx](file:///Users/kingnet/code_workspace/go_workspace/src/Semantic/src/views/AskDataView.tsx)

改造点：
- 顶部显示当前使用的语义版本
- 查询时绑定 Active 版本 ID

### 4.2 知识网络基于版本构建

- 每个语义版本对应一个 Graph 快照
- Graph 查询指定版本

---

## 验证计划

1. **版本创建**：BO 建模批量发布 → 验证语义版本草稿更新
2. **版本发布**：发布草稿 → 验证版本列表新增
3. **Active 切换**：切换 Active 版本 → 验证问数使用新版本
4. **路径统一**：自上而下/自下而上 → 验证都进入 BO 建模统一管理
5. **版本回滚**：回滚到历史版本 → 验证内容恢复

---

## 工作量预估

| Phase | 内容 | 预估 |
|-------|------|------|
| P1 | 数据模型 + 存储服务 | 2天 |
| P2 | 版本管理 UI | 3天 |
| P3 | 业务对象建模集成 | 3天 |
| P4 | 消费层绑定 | 2天 |
| **Total** |  | **10天** |

---

## 优先级建议

> [!IMPORTANT]
> 建议先完成 P1+P2+P3（核心能力 + 发布入口），P4 可后续迭代

