# 语义理解接口文档（20260115）

## 约定
- Base URL: `/api/semantic`
- 鉴权：`Authorization: Bearer <token>`
- 时间格式：`YYYY-MM-DD HH:mm:ss`
- 返回格式：
```
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

## 0. 数据模型与枚举
### 0.1 枚举
- GateResult: `PASS` / `REVIEW` / `REJECT`
- Status: `scanned` / `analyzed` / `pending_review` / `pending` / `ignored`
- SemanticRole: `Identifier` / `BusAttr` / `ForeignKey` / `Status` / `EventHint` / `Audit`
- ObjectType: `entity` / `event` / `state` / `rule` / `attribute`
- Sensitivity: `L1` / `L2` / `L3` / `L4`
- DataLayer: `ODS` / `DWD` / `DWS` / `ADS` / `DIM` / `其他`
- UpdateStrategy: `增量追加` / `全量覆盖` / `缓慢变化维`

### 0.2 表级结果结构（TableSemanticProfile）
```
{
  "tableName": "t_order",
  "gateResult": { "result": "PASS", "details": {}, "reasons": [] },
  "ruleScore": { "naming": 0.8, "behavior": 0.6, "comment": 0.7, "total": 0.7 },
  "aiScore": 0.76,
  "fieldScore": 0.7,
  "finalScore": 0.73,
  "scoreBreakdown": { "rule": 0.3, "field": 0.2, "ai": 0.5 },
  "businessName": "订单",
  "description": "交易订单核心对象",
  "tags": ["交易", "订单"],
  "aiEvidence": [],
  "aiEvidenceItems": [{ "field": "order_id", "reason": "主键特征明显", "weight": 0.8 }],
  "ruleEvidence": [],
  "objectType": "entity",
  "objectTypeReason": "具备稳定主键与完整生命周期",
  "businessDomain": "交易域",
  "dataGrain": "订单级",
  "dataLayer": "DWD",
  "updateStrategy": "增量追加",
  "retentionPeriod": "永久",
  "securityLevel": "L2",
  "relationships": [{ "targetTable": "t_user", "type": "Many-to-One", "key": "user_id", "description": "" }],
  "fields": []
}
```

### 0.3 字段结构（FieldSemanticProfile）
```
{
  "fieldName": "order_id",
  "dataType": "bigint",
  "role": "Identifier",
  "roleConfidence": 0.9,
  "sensitivity": "L2",
  "quality": "A",
  "businessTerm": "订单标识",
  "businessDefinition": "订单唯一标识",
  "logicalType": "ID",
  "unit": ""
}
```

## 1. 数据源与资产
### 1.1 获取数据源列表
- GET `/data-sources`
- Query: `env`, `type`
- 返回：
```
{ "data": [{ "id": "ds_1", "name": "MySQL-01", "type": "MySQL" }] }
```

### 1.2 获取资产列表（可筛选）
- GET `/assets`
- Query:
  - `sourceId` 数据源 ID（可选）
  - `status` scanned/analyzed/pending_review/pending
  - `keyword` 模糊搜索（表名/注释/业务名）
  - `page`, `pageSize`
- 返回：
```
{
  "data": {
    "total": 120,
    "list": [{
      "table": "t_order",
      "comment": "订单主表",
      "sourceId": "ds_1",
      "sourceType": "MySQL",
      "status": "analyzed",
      "semanticAnalysisId": "sa_1001"
    }]
  }
}
```

### 1.3 获取表结构详情
- GET `/assets/{table}/schema`
- 返回：
```
{
  "data": {
    "table": "t_order",
    "comment": "订单主表",
    "fields": [{ "name": "order_id", "type": "bigint", "comment": "订单ID" }]
  }
}
```

## 2. 语义理解任务
### 2.1 启动单表语义理解
- POST `/analysis/start`
- Body:
```
{
  "table": "t_order",
  "sourceId": "ds_1",
  "options": {
    "useAI": true,
    "useRules": true,
    "saveResult": false
  }
}
```
- 返回：
```
{ "data": { "taskId": "task_001", "status": "analyzing" } }
```

### 2.2 查询任务进度
- GET `/analysis/progress/{taskId}`
- 返回：
```
{
  "data": {
    "taskId": "task_001",
    "status": "analyzing",
    "step": "field_analysis",
    "percent": 42,
    "logs": ["规则门槛校验完成", "AI 识别进行中"]
  }
}
```

### 2.3 获取语义理解结果
- GET `/analysis/result/{taskId}`
- 返回（核心结构）：
```
{
  "data": {
    "tableName": "t_order",
    "gateResult": { "result": "PASS", "reasons": [] },
    "ruleScore": { "naming": 0.8, "behavior": 0.6, "comment": 0.7, "total": 0.7 },
    "aiScore": 0.76,
    "fieldScore": 0.7,
    "finalScore": 0.73,
    "scoreBreakdown": { "rule": 0.3, "field": 0.2, "ai": 0.5 },
    "businessName": "订单",
    "description": "交易订单核心对象",
    "tags": ["交易", "订单"],
    "aiEvidence": ["订单表字段符合交易特征"],
    "aiEvidenceItems": [{ "field": "order_id", "reason": "主键特征明显", "weight": 0.8 }],
    "ruleEvidence": ["表名前缀符合规范", "字段注释覆盖率高"],
    "fields": [{
      "fieldName": "order_id",
      "dataType": "bigint",
      "role": "Identifier",
      "roleConfidence": 0.9,
      "sensitivity": "L2"
    }]
  }
}
```

### 2.4 保存语义理解结果
- POST `/analysis/save`
- Body:
```
{
  "table": "t_order",
  "semanticProfile": { ...同 result... }
}
```

### 2.5 忽略/驳回语义理解结果
- POST `/analysis/ignore`
- Body: `{ "table": "t_order", "reason": "暂不处理" }`

## 3. 批量语义理解
### 3.1 启动批量任务
- POST `/analysis/batch/start`
- Body:
```
{
  "tables": ["t_order", "t_order_item"],
  "options": { "useAI": true, "useRules": true }
}
```
- 返回：`{ "data": { "batchId": "batch_001" } }`

### 3.2 查询批量进度
- GET `/analysis/batch/progress/{batchId}`
- 返回：
```
{ "data": { "current": 3, "total": 10, "status": "analyzing" } }
```

### 3.3 获取批量结果
- GET `/analysis/batch/result/{batchId}`
- 返回（简表）：
```
{
  "data": [{
    "tableId": "t_order",
    "tableName": "订单",
    "scorePercent": 86,
    "needsReview": false,
    "lowConfidenceReasons": []
  }]
}
```

## 4. 规则与证据
### 4.1 获取规则门槛结果
- POST `/rules/gatekeeper`
- Body: `{ "table": "t_order", "fields": [...] }`
- 返回：`{ "data": { "result": "PASS", "reasons": [] } }`

### 4.2 获取规则证据分组
- GET `/rules/evidence?table=t_order`
- 返回：
```
{
  "data": {
    "groups": {
      "命名规范": ["表名前缀符合规范"],
      "注释覆盖": ["字段注释覆盖率高"]
    }
  }
}
```

## 5. 字段与冲突处理
### 5.1 字段角色人工覆盖
- POST `/fields/override-role`
- Body:
```
{ "table": "t_order", "field": "order_status", "role": "Status", "source": "rule" }
```

### 5.2 字段敏感级别调整
- POST `/fields/override-sensitivity`
- Body:
```
{ "table": "t_order", "field": "buyer_phone", "sensitivity": "L4" }
```

### 5.3 冲突处理决策
- POST `/fields/resolve-conflict`
- Body:
```
{ "table": "t_order", "field": "status", "choice": "rule" }
```

## 6. 关系与图谱
### 6.1 查询表关系
- GET `/relationships?table=t_order`
- 返回：
```
{ "data": [{ "targetTable": "t_user", "type": "Many-to-One", "key": "user_id" }] }
```

### 6.2 新增/编辑/删除关系
- POST `/relationships`
- PUT `/relationships/{id}`
- DELETE `/relationships/{id}`
- Body: `{ "table": "t_order", "targetTable": "t_user", "type": "Many-to-One", "key": "user_id" }`

## 7. 升级建议与记录
### 7.1 获取升级建议
- GET `/upgrade/suggestions?table=t_order`
- 返回：
```
{ "data": { "beforeState": {...}, "afterState": {...}, "reason": "状态字段更适合作为状态对象" } }
```

### 7.2 接受/拒绝/稍后处理
- POST `/upgrade/decision`
- Body:
```
{ "table": "t_order", "decision": "accepted", "rejectReason": "" }
```

### 7.3 升级记录
- GET `/upgrade/history?table=t_order`

### 7.4 撤销升级
- POST `/upgrade/rollback`
- Body: `{ "historyId": "his_001" }`

## 8. 映射与业务对象
### 8.1 获取业务对象映射
- GET `/mapping/bo?table=t_order`

### 8.2 保存映射
- POST `/mapping/bo`
- Body:
```
{ "table": "t_order", "boId": "bo_order", "mapping": { "order_id": "id" } }
```

## 9. 导出与审计
### 9.1 导出语义理解报告
- GET `/export/report?table=t_order&format=pdf`

### 9.2 操作审计日志
- GET `/audit/logs?table=t_order`
