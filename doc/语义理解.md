# 语义理解规则清单

> 本文档定义了 **Bottom-up 自动识别** 的完整规则体系，包含表级和字段级语义分析。
> 规则设计原则：**可执行、可量化、可审核**。

---

## 一、表级：业务对象候选识别规则（Table → Business Object）

### 目标

> 判断一张表是否**描述一个现实中稳定存在的业务对象**

---

### 1️⃣ 表级识别规则总览

| 规则编号 | 规则名称 | 类型 | 权重 |
|---------|---------|------|------|
| T-01 | 表名语义判断 | 软规则 | 15% |
| T-02 | 主键结构判断 | **硬规则** | Gate |
| T-03 | 生命周期字段判断 | **硬规则** | Gate |
| T-04 | 表类型排除规则 | **硬规则** | Gate |
| T-05 | 行为密度判断 | 软规则 | 10% |
| T-06 | 表备注语义增强 | 软规则 | 20% |

---

### 2️⃣ 门控机制（Gate-Keeper）

> **硬规则任一失败 → 直接标记为"非业务候选"**

```
┌─────────────────────────────────────────────────┐
│                 输入：物理表元数据                │
└──────────────────────┬──────────────────────────┘
                       ▼
              ┌─────────────────┐
              │  T-02 主键校验   │──失败──▶ 排除
              └────────┬────────┘
                       ▼ 通过
              ┌─────────────────┐
              │  T-03 生命周期   │──失败──▶ 排除
              └────────┬────────┘
                       ▼ 通过
              ┌─────────────────┐
              │  T-04 表类型排除 │──失败──▶ 排除
              └────────┬────────┘
                       ▼ 通过
              ┌─────────────────┐
              │   进入软规则评分   │
              └─────────────────┘
```

---

### 3️⃣ 具体规则说明（表级）

#### T-01：表名语义判断（名词性）

**规则**
> 表名整体语义是**名词或名词短语**

**实现方式**
- 分词 / 词性标注
- 名词占比 > 60%

**示例**

| 表名 | 结果 | 说明 |
|------|------|------|
| user_info | ✔ | 名词短语 |
| order | ✔ | 名词 |
| user_log | ✖ | 含动词语义 |
| process_record | ⚠ | 边界情况 |

**判断依据**
> 业务对象是"存在的东西"，不是"发生的事情"

---

#### T-02：主键结构判断（必须 - 硬规则）

**规则**
> 表中存在**明确主键**

**通过条件**
- 单一主键（ID）
- 或复合业务主键

**排除**
- 无主键
- 仅时间 + 序号

**判断依据**
> 没有主键，无法标识"一个对象"

---

#### T-03：生命周期字段判断（必须 - 硬规则）

**规则**
> 至少存在一个生命周期字段

**字段类型**
- `create_time`
- `update_time`
- `effective_date`

**判断依据**
> 业务对象是有生命周期的

---

#### T-04：表类型排除规则（必须 - 硬规则）

**规则**
> 排除以下表类型

| 类型 | 典型特征 | 排除原因 |
|------|---------|---------|
| 日志表 | `log` / `trace` | 记录行为，非对象 |
| 明细表 | `detail` / `item` | 从属于主表 |
| 关系表 | `rel` / `map` | 多对多关联 |
| 临时表 | `tmp` / `temp` | 非持久化 |

**判断依据**
> 这些表不描述对象，只描述"使用痕迹"

---

#### T-05：行为密度判断（加权）

**规则**
> 行为字段占比 < 50%

**行为字段示例**
- 操作时间（`operate_time`）
- 操作人（`operator`）
- 操作类型（`action_type`）

**判断依据**
> 行为太多，说明这张表更像"过程记录"

---

#### T-06：表备注语义增强（加权）

**规则**
> 表备注能映射到业务名词

**示例**
> "存储用户基础信息" → 用户

**判断依据**
> 人写的备注是最真实的语义线索

---

### 4️⃣ 混合评分模型（AI + 规则融合）

> 通过门控后，进入软规则 + AI 混合评分

**公式**

```
Final_Score = 0.55 × AI_Score + 0.45 × Rule_Score
```

**Rule_Score 计算**

| 规则 | 权重 | 满分条件 |
|------|------|---------|
| T-01 表名语义 | 15% | 名词占比 > 60% |
| T-05 行为密度 | 10% | 行为字段 < 50% |
| T-06 表备注 | 20% | 备注可映射业务名词 |

**置信度阈值**

| 分数区间 | 判定结果 | 处理方式 |
|---------|---------|---------|
| ≥ 0.75 | ✅ 高质量候选 | 自动入库 |
| 0.45 ~ 0.75 | ⚠ 需人工审核 | 提示确认 |
| < 0.45 | ❌ 排除 | 标记为非业务实体 |

---

### 5️⃣ 表级语义输出结构

```typescript
interface TableSemanticProfile {
  // 门控结果
  gateResult: 'PASS' | 'REJECT' | 'REVIEW';
  gateDetail: {
    t02_primaryKey: 'pass' | 'fail';
    t03_lifecycle: 'pass' | 'fail';
    t04_tableType: 'pass' | 'fail';
  };
  
  // 评分
  ruleScore: number;       // 规则评分 (0-1)
  aiScore: number;         // AI 评分 (0-1)
  finalScore: number;      // 混合评分
  
  // AI 建议
  suggestedBusinessName: string;
  suggestedDescription: string;
  suggestedScenarios: string[];
  
  // 证据链
  aiEvidence: string[];    // AI 判断依据
}
```

---

## 二、字段级：语义维度框架（Column → Semantic Profile）

### 目标

> 从**多个维度**理解字段的业务含义，而非仅做角色分类

---

### 1️⃣ 字段语义七维度模型

| 维度编号 | 维度名称 | 描述 |
|---------|---------|------|
| D-01 | 语义角色 | 字段在业务中的角色 |
| D-02 | 数据类型语义 | 物理类型暗示的业务含义 |
| D-03 | 值域特征 | 取值范围和模式 |
| D-04 | 敏感性等级 | 隐私和合规要求 |
| D-05 | 业务元信息 | 业务名称和描述 |
| D-06 | 质量信号 | 数据质量指标 |
| D-07 | 关联性 | 与其他字段/表的关系 |

---

### 2️⃣ D-01：语义角色（Semantic Role）

> 字段在业务语境中扮演什么角色？

| 角色类型 | 含义 | 典型特征 | 优先级 |
|---------|------|---------|--------|
| **Identifier** | 主键/业务唯一标识 | `*_id`, `*_no`, `*_code` | 1 |
| **Foreign Key** | 外键，指向其他实体 | `user_id → t_user.id` | 2 |
| **Technical** | 技术/审计字段 | `create_by`, `is_deleted` | 3 |
| **Status** | 状态/阶段 | `status`, `state`, `phase` | 4 |
| **Event Hint** | 行为/事件线索 | `*_time`, `operate_type` | 5 |
| **Business Attr** | 业务属性（核心信息） | `name`, `amount` | 6 |

**判定规则**

| 规则编号 | 规则名称 | 判定条件 |
|---------|---------|---------|
| C-01 | 标识字段 | 主键约束 OR 字段名匹配 `*_id`, `*_no` |
| C-02 | 外键关系 | FK 约束 OR 字段名指向已知表 |
| C-03 | 技术字段 | 字段名匹配 `create_by`, `update_by`, `is_deleted`, `version` |
| C-04 | 状态字段 | 字段名含 `status`, `state`, `phase`, `flag` |
| C-05 | 行为线索 | 字段名含 `*_time`, `*_date` + 动词语义 |
| C-06 | 业务属性 | 未命中上述规则 |

**优先级说明**
> 当字段匹配多条规则时，按优先级取最高者

---

### 3️⃣ D-02：数据类型语义（Data Type Semantics）

> 字段的物理类型暗示什么业务含义？

| 物理类型 | 语义推断 | 业务意图 |
|---------|---------|---------|
| `varchar(18)` | 身份证号 | 唯一标识 + 高敏感 |
| `varchar(11)` | 手机号 | 联系方式 + 敏感 |
| `char(6)` | 行政区划码 | 地理维度 |
| `decimal(18,2)` | 金额 | 财务数据 + 可聚合 |
| `datetime` | 时间点 | 事件发生时刻 |
| `date` | 日期 | 生命周期节点 |
| `tinyint` / `enum` | 枚举/状态 | 有限值域 |
| `text` / `blob` | 非结构化 | 备注/附件 |

**推断规则**
- `varchar(18)` + 字段名含 `id_card` / `sfz` → 身份证号
- `varchar(11)` + 字段名含 `mobile` / `phone` → 手机号
- `decimal` + 字段名含 `amt` / `price` / `fee` → 金额

---

### 4️⃣ D-03：值域特征（Value Domain）

> 字段的取值范围是什么？

| 值域类型 | 描述 | 推断策略 |
|---------|------|---------|
| **枚举型** | 有限离散值 | `DISTINCT COUNT ≤ 20` |
| **范围型** | 连续数值 | 分析 `MIN/MAX/AVG` |
| **格式型** | 固定模式 | 正则匹配采样数据 |
| **自由文本** | 无固定模式 | 字符串长度分布 |

**常见格式模式**

| 格式 | 正则示例 | 业务含义 |
|------|---------|---------|
| 手机号 | `^1[3-9]\d{9}$` | 联系方式 |
| 身份证 | `^\d{17}[\dX]$` | 身份标识 |
| 邮箱 | `^[\w.-]+@[\w.-]+$` | 联系方式 |
| UUID | `^[a-f0-9-]{36}$` | 唯一标识 |

---

### 5️⃣ D-04：敏感性等级（Sensitivity Level）

> 字段是否涉及隐私或合规要求？

| 等级 | 描述 | 典型字段 | 处理要求 |
|-----|------|---------|---------|
| **L1** | 公开 | 订单号、商品名 | 无限制 |
| **L2** | 内部 | 部门、员工工号 | 内部可见 |
| **L3** | 个人 | 姓名、手机、地址 | 脱敏展示 |
| **L4** | 高敏 | 身份证、银行卡、病历 | 加密存储 |

**自动识别规则**

| 字段特征 | 推断等级 |
|---------|---------|
| 字段名含 `id_card` / `sfz` | L4 |
| 字段名含 `mobile` / `phone` | L3 |
| 字段名含 `name` + 类型 `varchar` | L3 |
| 字段名含 `address` / `addr` | L3 |
| 字段名含 `bank` / `card` | L4 |

---

### 6️⃣ D-05：业务元信息（Business Metadata）

> 字段的业务含义如何描述？

| 元信息 | 描述 | 来源 |
|-------|------|-----|
| **业务名称** | 中文名 | 字段注释 / AI 推断 |
| **业务描述** | 详细说明 | 字段注释 / AI 生成 |
| **所属业务域** | 归属模块 | 表名推断 / 配置 |
| **数据责任人** | 谁负责维护 | 元数据配置 |
| **数据标准** | 引用的标准代码 | 标准库匹配 |

---

### 7️⃣ D-06：质量信号（Quality Signals）

> 字段数据质量如何？

| 指标 | 描述 | 高质量阈值 |
|-----|------|----------|
| **空值率** | NULL 占比 | < 5% |
| **唯一性** | DISTINCT / TOTAL | ID 字段 = 100% |
| **完整性** | 非空非默认值占比 | > 80% |
| **一致性** | 格式符合预期占比 | > 95% |

**质量评级**

| 综合得分 | 评级 | 说明 |
|---------|------|------|
| ≥ 90% | A | 高质量 |
| 70% ~ 90% | B | 可用 |
| 50% ~ 70% | C | 需关注 |
| < 50% | D | 质量问题 |

---

### 8️⃣ D-07：关联性（Relationship Context）

> 字段与其他字段/表的关系？

| 关联类型 | 描述 | 推断策略 |
|---------|------|---------|
| **显式 FK** | DDL 定义的外键 | DDL 解析 |
| **隐式 FK** | 字段名暗示关系 | `user_id` → `t_user` |
| **派生字段** | 由其他字段计算 | `total = price * qty` |
| **冗余字段** | 与其他字段重复 | 数据比对 |

**隐式 FK 推断规则**
- 字段名匹配 `{table_name}_id` → 关联到 `t_{table_name}`
- 字段名匹配 `{entity}_id` → 检索已知实体表

---

### 9️⃣ 字段语义输出结构

```typescript
interface FieldSemanticProfile {
  // 基础信息
  physicalName: string;          // 物理字段名
  dataType: string;              // 物理类型
  
  // D-01 语义角色
  semanticRole: 'Identifier' | 'FK' | 'Technical' | 'Status' | 'Event' | 'BusAttr';
  roleConfidence: number;        // 角色置信度
  
  // D-02 数据类型语义
  inferredType: string;          // 推断的业务类型（如"手机号"）
  
  // D-03 值域
  valueDomain: 'Enum' | 'Range' | 'Pattern' | 'FreeText';
  enumValues?: string[];         // 枚举值列表
  valuePattern?: string;         // 格式正则
  
  // D-04 敏感性
  sensitivityLevel: 'L1' | 'L2' | 'L3' | 'L4';
  
  // D-05 业务元信息
  businessName: string;          // 业务名称
  businessDescription: string;   // 业务描述
  
  // D-06 质量
  nullRate: number;
  uniquenessRate: number;
  qualityGrade: 'A' | 'B' | 'C' | 'D';
  
  // D-07 关联
  relatedTable?: string;         // FK 指向表
  relatedField?: string;         // FK 指向字段
  relationshipType?: 'explicit' | 'implicit';
  
  // 判定结果
  ruleScore: number;             // 规则评分
  aiScore: number;               // AI 评分
  hasConflict: boolean;          // 规则与 AI 是否冲突
}
```

---

## 三、字段 → 状态/行为升级判断

### 触发条件

| 条件 | 升级类型 |
|-----|---------|
| 状态字段 + 多值（≥3） | **状态对象** |
| 时间字段 + 语义动词 | **行为对象** |

### 示例

| 字段 | 升级建议 | 说明 |
|-----|---------|------|
| `order_status` | 订单状态对象 | 含多个业务状态 |
| `pay_time` | 支付行为 | 记录支付事件 |
| `approve_time` | 审批行为 | 记录审批事件 |

---

## 四、规则执行顺序

```
输入：物理表 + 字段元数据
        ↓
   表级门控判断（硬规则）
        ↓ PASS
   表级软规则 + AI 评分
        ↓
   字段级七维度分析
        ↓
   状态/行为升级判断
        ↓
   生成语义 Profile
        ↓
   人工确认（如需）
        ↓
   输出：逻辑实体定义
```

---

## 五、设计原则

1. **规则是建议，不是结论** — 所有自动识别都可被人工拒绝
2. **透明可解释** — 每个判定都有证据链支撑
3. **AI 与规则互补** — 规则保底，AI 增强
4. **质量优先** — 宁可漏判，不可误判

---

## 六、与代码实现的对应关系

| 文档概念 | 代码实现 | 文件 |
|---------|---------|------|
| 门控机制 | `gateResult`, `gateDetail` | DataSemanticUnderstandingView.tsx |
| 混合评分 | `0.55 * aiScore + 0.45 * ruleScore` | handleAnalyze() |
| 字段角色 | `ruleRole`, `aiRole` | Field List 渲染 |
| 冲突检测 | `hasConflict` | AlertTriangle 提示 |
| ER 关联 | `relationships` | Relationship Graph Tab |

---

> **文档版本**: v2.0  
> **更新日期**: 2026-01-08  
> **维护人**: Semantic Layer Team
